<!DOCTYPE html>
<html>
<head>
    <title>Adaptive Loudness - Simple Demo</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            font-size: 18px;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
        }
        .info {
            background: #f0f0f0;
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
        }
        input[type="range"] {
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ Adaptive Loudness Demo (Simple)</h1>
    
    <div class="info">
        <p>ì´ ë°ëª¨ëŠ” AudioWorklet ì—†ì´ ScriptProcessorë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
        <p>ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ì‘ë™í•˜ì§€ë§Œ ì•½ê°„ì˜ ì§€ì—°ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    
    <button id="startBtn">ğŸµ ì‹œì‘</button>
    <button id="stopBtn" disabled>â¹ ì •ì§€</button>
    
    <h3>ì„¤ì •</h3>
    <label>
        í™˜ê²½ ì†ŒìŒ: <span id="noiseVal">40</span> dB<br>
        <input type="range" id="noise" min="20" max="80" value="40">
    </label>
    
    <label>
        <input type="checkbox" id="bypass"> ë°”ì´íŒ¨ìŠ¤ (ì²˜ë¦¬ ë„ê¸°)
    </label>
    
    <div class="info" id="status">ëŒ€ê¸° ì¤‘...</div>
    
    <script src="tidal.js"></script>
    <script>
        // ê°„ë‹¨í•œ ë²„ì „ì˜ Adaptive Loudness í”„ë¡œì„¸ì„œ
        class SimpleLoudnessProcessor {
            constructor(sampleRate) {
                this.sampleRate = sampleRate;
                this.taps = 257; // ë” ì‘ì€ í•„í„°
                this.coeffs = new Float32Array(this.taps);
                this.delayL = new Float32Array(this.taps);
                this.delayR = new Float32Array(this.taps);
                
                // ì´ˆê¸° í•„í„° (í†µê³¼)
                this.coeffs[Math.floor(this.taps / 2)] = 1.0;
                
                // ISO 226 ë°ì´í„° (ê°„ì†Œí™”)
                this.ISO_FREQ = [20, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000];
                this.ISO_40 = [96.9, 62.1, 48.7, 42.1, 36.3, 32.6, 28.4, 22.9, 17.8, 21.4];
                this.ISO_60 = [118.6, 81.3, 65.1, 57.3, 50.1, 45.6, 40.5, 33.7, 28.3, 32.3];
            }
            
            updateFilter(noiseDB) {
                // ê°„ë‹¨í•œ ë³´ì • ê³„ì‚°
                const targetPhon = noiseDB + 8;
                const refPhon = targetPhon + 5;
                
                // ì£¼íŒŒìˆ˜ë³„ ê²Œì¸ (40% ì¸ì§€ ë³´ìƒ)
                const gains = [];
                for (let i = 0; i < this.ISO_FREQ.length; i++) {
                    const diff = (this.ISO_60[i] - this.ISO_40[i]) * 0.4; // 40% ë³´ìƒ
                    gains.push(Math.pow(10, diff / 20));
                }
                
                // Nyquistê¹Œì§€ í™•ì¥
                const nyq = this.sampleRate / 2;
                const freqs = [0, ...this.ISO_FREQ.filter(f => f < nyq), nyq];
                const gainsExt = [gains[0], ...gains.slice(0, freqs.length - 2), gains[gains.length - 1]];
                
                // FIR í•„í„° ì„¤ê³„
                try {
                    this.coeffs = firwin2(this.taps, freqs, gainsExt, {
                        window: 'hamming',
                        fs: this.sampleRate
                    });
                } catch (e) {
                    console.error('í•„í„° ì„¤ê³„ ì‹¤íŒ¨:', e);
                }
            }
            
            process(inputL, inputR, outputL, outputR) {
                // ê°„ë‹¨í•œ FIR í•„í„°ë§
                for (let n = 0; n < inputL.length; n++) {
                    let sumL = 0, sumR = 0;
                    
                    // ì»¨ë³¼ë£¨ì…˜
                    for (let k = 0; k < this.taps; k++) {
                        const idx = n - k;
                        if (idx >= 0) {
                            sumL += inputL[idx] * this.coeffs[k];
                            sumR += inputR[idx] * this.coeffs[k];
                        } else {
                            sumL += this.delayL[this.taps + idx] * this.coeffs[k];
                            sumR += this.delayR[this.taps + idx] * this.coeffs[k];
                        }
                    }
                    
                    outputL[n] = sumL;
                    outputR[n] = sumR;
                }
                
                // ì§€ì—° ë²„í¼ ì—…ë°ì´íŠ¸
                const copyLen = Math.min(this.taps, inputL.length);
                for (let i = 0; i < this.taps - copyLen; i++) {
                    this.delayL[i] = this.delayL[i + copyLen];
                    this.delayR[i] = this.delayR[i + copyLen];
                }
                for (let i = 0; i < copyLen; i++) {
                    this.delayL[this.taps - copyLen + i] = inputL[inputL.length - copyLen + i];
                    this.delayR[this.taps - copyLen + i] = inputR[inputR.length - copyLen + i];
                }
            }
        }
        
        // ì „ì—­ ë³€ìˆ˜
        let audioContext = null;
        let processor = null;
        let scriptNode = null;
        let sourceNode = null;
        let isPlaying = false;
        
        // UI ìš”ì†Œ
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const noiseSlider = document.getElementById('noise');
        const bypassCheck = document.getElementById('bypass');
        const statusDiv = document.getElementById('status');
        
        // ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
        noiseSlider.oninput = () => {
            document.getElementById('noiseVal').textContent = noiseSlider.value;
            if (processor) {
                processor.updateFilter(parseFloat(noiseSlider.value));
            }
        };
        
        // ì‹œì‘ ë²„íŠ¼
        startBtn.onclick = async () => {
            try {
                // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                processor = new SimpleLoudnessProcessor(audioContext.sampleRate);
                
                // ì´ˆê¸° í•„í„° ì„¤ì •
                processor.updateFilter(parseFloat(noiseSlider.value));
                
                // ë§ˆì´í¬ ì…ë ¥
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                sourceNode = audioContext.createMediaStreamSource(stream);
                
                // ScriptProcessor ìƒì„±
                scriptNode = audioContext.createScriptProcessor(4096, 2, 2);
                
                scriptNode.onaudioprocess = (e) => {
                    const inputL = e.inputBuffer.getChannelData(0);
                    const inputR = e.inputBuffer.getChannelData(1);
                    const outputL = e.outputBuffer.getChannelData(0);
                    const outputR = e.outputBuffer.getChannelData(1);
                    
                    if (bypassCheck.checked) {
                        // ë°”ì´íŒ¨ìŠ¤
                        outputL.set(inputL);
                        outputR.set(inputR);
                    } else {
                        // ì²˜ë¦¬
                        processor.process(inputL, inputR, outputL, outputR);
                    }
                };
                
                // ì—°ê²°
                sourceNode.connect(scriptNode);
                scriptNode.connect(audioContext.destination);
                
                isPlaying = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                statusDiv.textContent = 'ì²˜ë¦¬ ì¤‘... ğŸµ';
                
            } catch (error) {
                statusDiv.textContent = 'ì˜¤ë¥˜: ' + error.message;
                console.error(error);
            }
        };
        
        // ì •ì§€ ë²„íŠ¼
        stopBtn.onclick = () => {
            if (sourceNode) {
                sourceNode.disconnect();
                if (sourceNode.mediaStream) {
                    sourceNode.mediaStream.getTracks().forEach(track => track.stop());
                }
            }
            if (scriptNode) {
                scriptNode.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }
            
            isPlaying = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusDiv.textContent = 'ì •ì§€ë¨';
        };
    </script>
</body>
</html>