<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Filter Crossfade - Fixed Version</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent-color: #00D4D4;
            --accent-hover: #00E8E8;
            --border-color: rgba(255, 255, 255, 0.1);
            --filter-a: #FF6B6B;
            --filter-b: #4ECDC4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--accent-color);
            margin-bottom: 30px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .filter-a h2 {
            color: var(--filter-a);
        }

        .filter-b h2 {
            color: var(--filter-b);
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .value-display {
            text-align: right;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .crossfade-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .crossfade-viz {
            height: 60px;
            background: linear-gradient(to right, var(--filter-a), var(--filter-b));
            border-radius: 30px;
            position: relative;
            margin: 20px 0;
        }

        .crossfade-indicator {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: left 0.1s ease-out;
        }

        .crossfade-value {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 20px 0;
            color: var(--accent-color);
        }

        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--accent-color);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .file-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
        }

        .file-input:hover {
            border-color: var(--accent-color);
        }

        .status {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .eq-display {
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .eq-bar {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .eq-label {
            width: 60px;
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .eq-value {
            flex: 1;
            height: 20px;
            background: var(--bg-primary);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .eq-fill {
            position: absolute;
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s ease;
        }

        .filter-a .eq-fill {
            background: var(--filter-a);
        }

        .filter-b .eq-fill {
            background: var(--filter-b);
        }

        #gainCanvas {
            width: 100%;
            height: 200px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dual Filter Crossfade Demo</h1>
        
        <input type="file" id="audioFile" accept="audio/*" class="file-input" placeholder="Click to select audio file">
        
        <div class="main-grid">
            <!-- Filter A -->
            <div class="card filter-a">
                <h2>🔴 Filter A</h2>
                
                <div class="control-group">
                    <label>Bass Boost (100 Hz)</label>
                    <input type="range" id="bassA" min="-10" max="10" value="3" step="0.5">
                    <div class="value-display" id="bassAValue">+3.0 dB</div>
                </div>
                
                <div class="control-group">
                    <label>Mid Boost (1 kHz)</label>
                    <input type="range" id="midA" min="-10" max="10" value="0" step="0.5">
                    <div class="value-display" id="midAValue">0.0 dB</div>
                </div>
                
                <div class="control-group">
                    <label>Treble Boost (8 kHz)</label>
                    <input type="range" id="trebleA" min="-10" max="10" value="-2" step="0.5">
                    <div class="value-display" id="trebleAValue">-2.0 dB</div>
                </div>
                
                <div class="eq-display">
                    <div class="eq-bar">
                        <span class="eq-label">100 Hz</span>
                        <div class="eq-value">
                            <div class="eq-fill" id="bassABar" style="width: 65%"></div>
                        </div>
                    </div>
                    <div class="eq-bar">
                        <span class="eq-label">1 kHz</span>
                        <div class="eq-value">
                            <div class="eq-fill" id="midABar" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="eq-bar">
                        <span class="eq-label">8 kHz</span>
                        <div class="eq-value">
                            <div class="eq-fill" id="trebleABar" style="width: 40%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filter B -->
            <div class="card filter-b">
                <h2>🔵 Filter B</h2>
                
                <div class="control-group">
                    <label>Bass Boost (100 Hz)</label>
                    <input type="range" id="bassB" min="-10" max="10" value="6" step="0.5">
                    <div class="value-display" id="bassBValue">+6.0 dB</div>
                </div>
                
                <div class="control-group">
                    <label>Mid Boost (1 kHz)</label>
                    <input type="range" id="midB" min="-10" max="10" value="2" step="0.5">
                    <div class="value-display" id="midBValue">+2.0 dB</div>
                </div>
                
                <div class="control-group">
                    <label>Treble Boost (8 kHz)</label>
                    <input type="range" id="trebleB" min="-10" max="10" value="4" step="0.5">
                    <div class="value-display" id="trebleBValue">+4.0 dB</div>
                </div>
                
                <div class="eq-display">
                    <div class="eq-bar">
                        <span class="eq-label">100 Hz</span>
                        <div class="eq-value">
                            <div class="eq-fill" id="bassBBar" style="width: 80%"></div>
                        </div>
                    </div>
                    <div class="eq-bar">
                        <span class="eq-label">1 kHz</span>
                        <div class="eq-value">
                            <div class="eq-fill" id="midBBar" style="width: 60%"></div>
                        </div>
                    </div>
                    <div class="eq-bar">
                        <span class="eq-label">8 kHz</span>
                        <div class="eq-value">
                            <div class="eq-fill" id="trebleBBar" style="width: 70%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Crossfade Control -->
        <div class="crossfade-section">
            <h2>Crossfade Control</h2>
            <div class="crossfade-value" id="crossfadeDisplay">Filter A: 100% | Filter B: 0%</div>
            
            <div class="crossfade-viz">
                <div class="crossfade-indicator" style="left: 0%"></div>
            </div>
            
            <input type="range" id="crossfade" min="0" max="100" value="0">
            
            <div class="control-group" style="margin-top: 20px;">
                <label>Max Gain Reduction at 50% Mix</label>
                <input type="range" id="maxReduction" min="-6" max="0" value="-3" step="0.1">
                <div class="value-display" style="color: var(--accent-color)" id="reductionValue">-3.0 dB</div>
            </div>
            
            <button class="btn-primary" id="playBtn">▶️ Play / ⏸ Pause</button>
            
            <canvas id="gainCanvas"></canvas>
            
            <div class="status" id="status">
                Status: Ready<br>
                Current Gain: 0.0 dB<br>
                Press 1-9,0 for crossfade positions
            </div>
        </div>
    </div>

    <script>
        class SimpleDualFilterDemo {
            constructor() {
                console.log('SimpleDualFilterDemo constructor called');
                
                this.audioContext = null;
                this.source = null;
                this.audioBuffer = null;
                this.isPlaying = false;
                
                // Filter parameters
                this.filterA = {
                    bass: 3,
                    mid: 0,
                    treble: -2
                };
                
                this.filterB = {
                    bass: 6,
                    mid: 2,
                    treble: 4
                };
                
                this.crossfade = 0;
                this.maxReduction = -3;
                
                console.log('Initial filter settings:', { filterA: this.filterA, filterB: this.filterB });
                
                // Audio nodes
                this.setupNodes();
                this.setupUI();
                this.updateVisualization();
                
                console.log('SimpleDualFilterDemo initialized');
            }
            
            async init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }
            
            setupNodes() {
                // We'll create these when needed
                this.nodesA = null;
                this.nodesB = null;
            }
            
            async loadAudio(file) {
                console.log('Loading audio file:', file.name);
                await this.init();
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    console.log('File read, size:', arrayBuffer.byteLength, 'bytes');
                    
                    this.audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    console.log('Audio decoded successfully:', this.audioBuffer.duration, 'seconds');
                    
                    document.getElementById('status').innerHTML = 
                        `Status: File loaded (${this.audioContext.sampleRate} Hz)<br>` +
                        `Current Gain: 0.0 dB<br>` +
                        `Press 1-9,0 for crossfade positions`;
                        
                    console.log('Audio file loaded successfully');
                } catch (error) {
                    console.error('Error loading audio:', error);
                    alert('Error loading audio file: ' + error.message);
                }
            }
            
            createFilterChain(filterParams, name) {
                console.log(`Creating filter chain ${name} with params:`, filterParams);
                
                // Create nodes
                const bassFilter = this.audioContext.createBiquadFilter();
                bassFilter.type = 'lowshelf';
                bassFilter.frequency.value = 100;
                bassFilter.gain.value = filterParams.bass;
                
                const midFilter = this.audioContext.createBiquadFilter();
                midFilter.type = 'peaking';
                midFilter.frequency.value = 1000;
                midFilter.Q.value = 1;
                midFilter.gain.value = filterParams.mid;
                
                const trebleFilter = this.audioContext.createBiquadFilter();
                trebleFilter.type = 'highshelf';
                trebleFilter.frequency.value = 8000;
                trebleFilter.gain.value = filterParams.treble;
                
                // IMPORTANT: Create separate gain node for crossfade control
                const crossfadeGain = this.audioContext.createGain();
                crossfadeGain.gain.value = 0; // Start at 0
                
                // Connect chain: bass -> mid -> treble -> crossfadeGain
                bassFilter.connect(midFilter);
                midFilter.connect(trebleFilter);
                trebleFilter.connect(crossfadeGain);
                
                console.log(`Filter chain ${name} created successfully`);
                
                return {
                    input: bassFilter,
                    output: crossfadeGain,
                    crossfadeGain: crossfadeGain,
                    filters: { bass: bassFilter, mid: midFilter, treble: trebleFilter }
                };
            }
            
            createAudioGraph() {
                // Clean up existing
                if (this.source) {
                    this.source.stop();
                    this.source.disconnect();
                }
                
                // Create source
                this.source = this.audioContext.createBufferSource();
                this.source.buffer = this.audioBuffer;
                this.source.loop = true;
                
                console.log('Creating filter chains...');
                
                // Create filter chains with names for debugging
                this.nodesA = this.createFilterChain(this.filterA, 'A');
                this.nodesB = this.createFilterChain(this.filterB, 'B');
                
                console.log('Filter A chain:', this.nodesA);
                console.log('Filter B chain:', this.nodesB);
                
                // Create compensation gain
                this.compensationGain = this.audioContext.createGain();
                
                // Connect graph
                console.log('Connecting audio graph...');
                this.source.connect(this.nodesA.input);
                this.source.connect(this.nodesB.input);
                
                this.nodesA.output.connect(this.compensationGain);
                this.nodesB.output.connect(this.compensationGain);
                
                this.compensationGain.connect(this.audioContext.destination);
                
                console.log('Audio graph connected successfully');
                
                // Set initial crossfade
                this.updateCrossfade();
            }
            
            updateCrossfade() {
                const value = this.crossfade / 100;
                
                // Equal-power crossfade
                const angle = value * Math.PI / 2;
                const levelA = Math.cos(angle);
                const levelB = Math.sin(angle);
                
                console.log(`Crossfade: ${this.crossfade}%, A: ${levelA.toFixed(3)}, B: ${levelB.toFixed(3)}`);
                
                if (this.nodesA && this.nodesB) {
                    const now = this.audioContext.currentTime;
                    this.nodesA.crossfadeGain.gain.linearRampToValueAtTime(levelA, now + 0.05);
                    this.nodesB.crossfadeGain.gain.linearRampToValueAtTime(levelB, now + 0.05);
                    
                    // Log current gain values
                    console.log(`Setting crossfade gains - A: ${levelA}, B: ${levelB}`);
                }
                
                // Calculate compensation
                const compensation = this.calculateCompensation(value);
                if (this.compensationGain) {
                    const now = this.audioContext.currentTime;
                    this.compensationGain.gain.linearRampToValueAtTime(compensation, now + 0.05);
                }
                
                // Update displays
                const percentA = Math.round((1 - value) * 100);
                const percentB = Math.round(value * 100);
                document.getElementById('crossfadeDisplay').textContent = 
                    `Filter A: ${percentA}% | Filter B: ${percentB}%`;
                
                const gainDb = 20 * Math.log10(compensation);
                document.getElementById('status').innerHTML = 
                    `Status: ${this.isPlaying ? 'Playing' : 'Ready'}<br>` +
                    `Current Gain: ${gainDb.toFixed(1)} dB<br>` +
                    `Press 1-9,0 for crossfade positions`;
                
                // Update indicator
                document.querySelector('.crossfade-indicator').style.left = `${this.crossfade}%`;
                
                this.drawGainCurve();
            }
            
            calculateCompensation(crossfade) {
                const reduction = this.maxReduction * 4 * crossfade * (1 - crossfade);
                return Math.pow(10, reduction / 20);
            }
            
            updateFilters() {
                if (!this.nodesA || !this.nodesB) {
                    console.log('updateFilters: nodes not ready');
                    return;
                }
                
                const now = this.audioContext.currentTime;
                
                console.log('Updating Filter A:', this.filterA);
                console.log('Updating Filter B:', this.filterB);
                
                // Update Filter A
                this.nodesA.filters.bass.gain.linearRampToValueAtTime(this.filterA.bass, now + 0.1);
                this.nodesA.filters.mid.gain.linearRampToValueAtTime(this.filterA.mid, now + 0.1);
                this.nodesA.filters.treble.gain.linearRampToValueAtTime(this.filterA.treble, now + 0.1);
                
                // Update Filter B
                this.nodesB.filters.bass.gain.linearRampToValueAtTime(this.filterB.bass, now + 0.1);
                this.nodesB.filters.mid.gain.linearRampToValueAtTime(this.filterB.mid, now + 0.1);
                this.nodesB.filters.treble.gain.linearRampToValueAtTime(this.filterB.treble, now + 0.1);
                
                console.log('Filters updated successfully');
            }
            
            play() {
                console.log('Play button clicked');
                
                if (!this.audioBuffer) {
                    console.log('No audio buffer loaded');
                    alert('Please load an audio file first');
                    return;
                }
                
                console.log('Audio buffer available, duration:', this.audioBuffer.duration);
                
                if (this.isPlaying) {
                    console.log('Pausing playback');
                    this.audioContext.suspend();
                    this.isPlaying = false;
                    document.getElementById('playBtn').textContent = '▶️ Play / ⏸ Pause';
                } else {
                    if (!this.source) {
                        console.log('Creating new audio graph');
                        this.createAudioGraph();
                        this.source.start(0);
                        console.log('Playback started');
                    } else {
                        console.log('Resuming audio context');
                        this.audioContext.resume();
                    }
                    this.isPlaying = true;
                    document.getElementById('playBtn').textContent = '⏸ Pause / ▶️ Play';
                }
                
                this.updateCrossfade();
            }
            
            updateVisualization() {
                // Update EQ bars
                const updateBar = (id, value) => {
                    const percent = ((value + 10) / 20) * 100;
                    document.getElementById(id).style.width = `${percent}%`;
                };
                
                updateBar('bassABar', this.filterA.bass);
                updateBar('midABar', this.filterA.mid);
                updateBar('trebleABar', this.filterA.treble);
                updateBar('bassBBar', this.filterB.bass);
                updateBar('midBBar', this.filterB.mid);
                updateBar('trebleBBar', this.filterB.treble);
            }
            
            drawGainCurve() {
                const canvas = document.getElementById('gainCanvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw curve
                ctx.strokeStyle = '#00D4D4';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                for (let i = 0; i <= 100; i++) {
                    const x = (i / 100) * canvas.width;
                    const crossfade = i / 100;
                    const gain = this.calculateCompensation(crossfade);
                    const gainDb = 20 * Math.log10(gain);
                    const y = canvas.height - ((gainDb - this.maxReduction) / -this.maxReduction) * canvas.height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                
                // Current position
                const currentX = (this.crossfade / 100) * canvas.width;
                const currentGain = this.calculateCompensation(this.crossfade / 100);
                const currentGainDb = 20 * Math.log10(currentGain);
                const currentY = canvas.height - ((currentGainDb - this.maxReduction) / -this.maxReduction) * canvas.height;
                
                ctx.fillStyle = '#00D4D4';
                ctx.beginPath();
                ctx.arc(currentX, currentY, 6, 0, 2 * Math.PI);
                ctx.fill();
                
                // Labels
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.font = '11px sans-serif';
                ctx.fillText('0 dB', 5, 15);
                ctx.fillText(`${this.maxReduction} dB`, 5, canvas.height - 5);
            }
            
            setupUI() {
                // File input
                document.getElementById('audioFile').addEventListener('change', async (e) => {
                    console.log('File input changed');
                    const file = e.target.files[0];
                    if (file) {
                        console.log('Selected file:', file.name, file.type, file.size, 'bytes');
                        await this.loadAudio(file);
                    } else {
                        console.log('No file selected');
                    }
                });
                
                // Filter A controls
                const setupSlider = (id, filter, param, displayId) => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        this[filter][param] = value;
                        document.getElementById(displayId).textContent = 
                            `${value >= 0 ? '+' : ''}${value.toFixed(1)} dB`;
                        this.updateFilters();
                        this.updateVisualization();
                    });
                };
                
                setupSlider('bassA', 'filterA', 'bass', 'bassAValue');
                setupSlider('midA', 'filterA', 'mid', 'midAValue');
                setupSlider('trebleA', 'filterA', 'treble', 'trebleAValue');
                setupSlider('bassB', 'filterB', 'bass', 'bassBValue');
                setupSlider('midB', 'filterB', 'mid', 'midBValue');
                setupSlider('trebleB', 'filterB', 'treble', 'trebleBValue');
                
                // Crossfade
                document.getElementById('crossfade').addEventListener('input', (e) => {
                    this.crossfade = parseFloat(e.target.value);
                    this.updateCrossfade();
                });
                
                // Max reduction
                document.getElementById('maxReduction').addEventListener('input', (e) => {
                    this.maxReduction = parseFloat(e.target.value);
                    document.getElementById('reductionValue').textContent = `${this.maxReduction.toFixed(1)} dB`;
                    this.updateCrossfade();
                });
                
                // Play button
                document.getElementById('playBtn').addEventListener('click', () => {
                    console.log('Play button event triggered');
                    this.play();
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key >= '0' && e.key <= '9') {
                        const value = e.key === '0' ? 100 : (parseInt(e.key) - 1) * 11.11;
                        document.getElementById('crossfade').value = value;
                        document.getElementById('crossfade').dispatchEvent(new Event('input'));
                    } else if (e.key === ' ') {
                        e.preventDefault();
                        this.play();
                    }
                });
            }
        }
        
        // Initialize
        console.log('Creating SimpleDualFilterDemo instance...');
        const demo = new SimpleDualFilterDemo();
        console.log('Demo instance created:', demo);
    </script>
</body>
</html>